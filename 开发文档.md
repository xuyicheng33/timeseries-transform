时序数据预测平台 - 开发文档
一、项目概述
1.1 项目定位
这是一个时序数据预测结果管理与可视化平台，主要用于：
管理时序数据集（上传、预览、下载）
配置数据预处理参数（归一化、窗口化、异常注入等）
上传和管理预测结果
多模型预测结果可视化对比
计算评估指标（MSE、RMSE、MAE、R²、MAPE）
1.2 技术栈
后端：
Python 3.11+
FastAPI 0.109（异步 Web 框架）
SQLAlchemy 2.0 + aiosqlite（异步 ORM + SQLite）
Alembic（数据库迁移）
Pandas + NumPy（数据处理）
python-jose + passlib（JWT 认证）
前端：
React 19 + TypeScript 5.9
Vite 7（构建工具）
Ant Design 6（UI 组件库）
ECharts 6（图表库）
Axios（HTTP 客户端）
React Router 7（路由）
二、项目结构
timeseries-platform/├── backend/                    # 后端代码│   ├── app/│   │   ├── api/               # API 路由│   │   │   ├── auth.py        # 认证接口│   │   │   ├── datasets.py    # 数据集接口│   │   │   ├── configurations.py  # 配置接口│   │   │   ├── results.py     # 结果接口│   │   │   └── visualization.py   # 可视化接口│   │   ├── models/            # 数据库模型│   │   │   └── models.py      # User, Dataset, Configuration, Result│   │   ├── schemas/           # Pydantic 模型│   │   │   └── schemas.py     # 请求/响应模型│   │   ├── services/          # 业务逻辑│   │   │   ├── auth.py        # JWT 生成/验证│   │   │   └── utils.py       # 降采样、指标计算│   │   ├── config.py          # 配置管理│   │   ├── database.py        # 数据库连接│   │   └── main.py            # 应用入口│   ├── migrations/            # Alembic 迁移│   ├── uploads/               # 上传文件存储│   │   ├── datasets/          # 数据集文件│   │   ├── results/           # 结果文件│   │   └── cache/             # 降采样缓存│   ├── requirements.txt│   └── alembic.ini│├── frontend/                   # 前端代码│   ├── src/│   │   ├── api/               # API 调用│   │   │   ├── request.ts     # Axios 实例（含 Token 刷新）│   │   │   ├── auth.ts        # 认证 API│   │   │   ├── datasets.ts    # 数据集 API│   │   │   ├── configurations.ts│   │   │   ├── results.ts│   │   │   └── visualization.ts│   │   ├── components/        # 公共组件│   │   │   ├── MainLayout.tsx # 主布局│   │   │   ├── RouteGuard.tsx # 路由守卫│   │   │   └── ErrorBoundary.tsx│   │   ├── contexts/          # React Context│   │   │   └── AuthContext.tsx # 认证状态管理│   │   ├── pages/             # 页面组件│   │   │   ├── Login.tsx      # 登录页│   │   │   ├── Register.tsx   # 注册页│   │   │   ├── DataHub.tsx    # 数据中心│   │   │   ├── ConfigWizard.tsx # 配置向导│   │   │   ├── ResultRepo.tsx # 结果仓库│   │   │   └── Visualization.tsx # 可视化对比│   │   ├── types/             # TypeScript 类型│   │   ├── utils/             # 工具函数│   │   ├── constants/         # 常量和路由│   │   └── App.tsx│   ├── package.json│   └── vite.config.ts│└── test_data/                  # 测试数据
三、数据库模型
3.1 User（用户）
- id: 主键- username: 用户名（唯一）- email: 邮箱（唯一）- hashed_password: 加密密码- full_name: 全名- is_active: 是否激活- is_admin: 是否管理员- created_at, updated_at, last_login
3.2 Dataset（数据集）
- id: 主键- name: 名称- filename: 原始文件名- filepath: 存储路径- file_size: 文件大小- row_count, column_count: 行列数- columns: 列名列表（JSON）- encoding: 文件编码- description: 描述- user_id: 上传用户（外键，可选）- is_public: 是否公开
3.3 Configuration（配置）
- id: 主键- name: 配置名称- dataset_id: 关联数据集（外键）- channels: 选择的通道列表- normalization: 归一化方式（none/minmax/zscore）- anomaly_enabled: 是否启用异常注入- anomaly_type: 异常类型- injection_algorithm: 注入算法- sequence_logic: 序列逻辑- window_size: 窗口大小- stride: 步长- target_type: 目标类型（next/last_k/all）- target_k: K 值- generated_filename: 生成的文件名
3.4 Result（结果）
- id: 主键- name: 结果名称- dataset_id: 关联数据集（外键）- configuration_id: 关联配置（外键，可选）- user_id: 上传用户（外键，可选）- filename: 文件名- filepath: 存储路径- algo_name: 算法名称- algo_version: 算法版本- description: 描述- row_count: 行数- metrics: 评估指标（JSON）
四、API 接口
4.1 认证接口 /api/auth
方法	路径	说明
POST	/register	用户注册
POST	/login/json	用户登录（JSON）
POST	/refresh	刷新 Token
GET	/me	获取当前用户
PUT	/me	更新用户信息
PUT	/me/password	修改密码
4.2 数据集接口 /api/datasets
方法	路径	说明
GET	/	获取数据集列表（分页）
POST	/	上传数据集（multipart/form-data）
GET	/{id}	获取数据集详情
PUT	/{id}	更新数据集信息
DELETE	/{id}	删除数据集
GET	/{id}/preview	预览数据（前100行）
GET	/{id}/download	下载数据集文件
4.3 配置接口 /api/configurations
方法	路径	说明
GET	/	获取配置列表
POST	/	创建配置
GET	/{id}	获取配置详情
PUT	/{id}	更新配置
DELETE	/{id}	删除配置
POST	/generate-filename	生成配置文件名
4.4 结果接口 /api/results
方法	路径	说明
GET	/	获取结果列表（分页）
POST	/	上传结果（multipart/form-data）
GET	/{id}	获取结果详情
PUT	/{id}	更新结果信息
DELETE	/{id}	删除结果
GET	/{id}/download	下载结果文件
4.5 可视化接口 /api/visualization
方法	路径	说明
POST	/compare	多结果对比（返回图表数据+指标）
GET	/metrics/{id}	获取单个结果的指标
五、核心功能实现
5.1 Token 认证流程
用户登录 → 返回 access_token（30分钟）+ refresh_token（7天）
前端请求自动附加 Authorization: Bearer {token}
Token 过期 → 自动用 refresh_token 刷新
refresh_token 也过期 → 跳转登录页
5.2 文件上传
数据集：支持 CSV/Excel，自动检测编码
结果：必须包含 true_value 和 predicted_value 列
存储路径：uploads/datasets/{dataset_id}/data.csv
结果路径：uploads/results/{dataset_id}/{result_id}/prediction.csv
5.3 可视化对比
支持同时对比最多 10 个结果
大数据降采样算法：LTTB（默认）、MinMax、Average
降采样结果缓存到 uploads/cache/
只读取必要列（true_value, predicted_value）优化性能
5.4 评估指标
MSE：均方误差
RMSE：均方根误差
MAE：平均绝对误差
R²：决定系数
MAPE：平均绝对百分比误差
六、已完成功能
模块	功能	状态
认证	注册/登录/Token刷新	✅
认证	路由守卫/自动跳转	✅
数据集	上传/预览/下载/删除	✅
数据集	编码自动检测	✅
配置	配置向导（5步）	✅
配置	文件名自动生成	✅
结果	上传/编辑/删除	✅
可视化	多结果对比图表	✅
可视化	评估指标计算	✅
性能	降采样算法	✅
性能	只读必要列	✅
性能	缓存降采样结果	✅
七、后续开发规划
7.1 短期（1-2周）
P0 - 必须完成
Docker 容器化
创建 Dockerfile（后端）
创建 Dockerfile（前端 Nginx）
创建 docker-compose.yml
支持一键部署
生产环境配置
环境变量管理
日志配置
错误监控
P1 - 重要功能
时间戳支持
自动识别时间列
X 轴显示真实时间
时间范围筛选
配置模板
保存常用配置为模板
从模板快速创建配置
模板管理（编辑/删除）
7.2 中期（1个月）
功能增强
批量操作
批量删除数据集/结果
批量下载
批量导出指标
数据集增强
支持更多格式（Parquet、JSON）
数据统计信息（均值、方差、分布）
数据质量检查（缺失值、异常值）
可视化增强
支持缩放和平移
导出图表为图片
自定义图表样式
残差图、散点图
用户体验
深色模式
国际化（中英文）
快捷键支持
操作历史记录
7.3 长期（2-3个月）
架构升级
数据库迁移
支持 PostgreSQL
支持 MySQL
数据库连接池优化
文件存储
支持 MinIO/S3 对象存储
文件分片上传
断点续传
性能优化
Redis 缓存
异步任务队列（Celery）
大文件流式处理
高级功能
团队协作
工作空间/项目管理
成员权限控制
操作审计日志
自动化
定时任务
Webhook 通知
API 调用统计
AI 集成
模型训练集成
自动超参数调优
预测结果自动评估
八、开发指南
8.1 本地开发
后端启动：
cd backendpython -m venv venvvenv\Scripts\activate  # Windowspip install -r requirements.txtalembic upgrade headuvicorn app.main:app --reload --port 8000
前端启动：
cd frontendnpm installnpm run dev
8.2 添加新 API
在 app/api/ 创建路由文件
在 app/schemas/schemas.py 添加请求/响应模型
在 app/models/models.py 添加数据库模型（如需要）
在 app/main.py 注册路由
创建 Alembic 迁移（如有数据库变更）
8.3 添加新页面
在 src/pages/ 创建页面组件
在 src/constants/routes.tsx 添加路由
在 src/api/ 添加 API 调用
在 src/types/ 添加类型定义
8.4 代码规范
后端：
使用 async/await 异步编程
所有 API 都要有类型注解
错误使用 HTTPException 抛出
敏感信息不要硬编码
前端：
使用 TypeScript 严格模式
类型导入使用 import type
组件使用函数式组件 + Hooks
状态管理优先使用 Context
九、常见问题
Q1: Windows 下 alembic 报编码错误
解决： 确保 alembic.ini 中没有中文注释
Q2: 前端构建报类型错误
解决： 类型导入使用 import type { XXX }
Q3: 登录后 401 错误
解决： 检查 Token 是否正确保存到 localStorage
Q4: 大文件上传超时
解决： 调整 Nginx/后端的超时配置
Q5: 图表渲染卡顿
解决： 减少 max_points 参数，使用降采样
十、更新日志

## v1.1.0 (2026-01-08) - 安全与架构修复

### 🔴 P0 级修复（安全/核心功能）

1. **资源鉴权/授权完善**
   - 所有 API 接口添加用户认证 (`get_current_user` / `get_current_user_optional`)
   - 实现数据隔离模式 (`ENABLE_DATA_ISOLATION` 配置)
   - 添加资源权限检查（所有者/管理员/公开数据）

2. **可视化缓存重做**
   - 只缓存降采样后的点和元信息，不再存储全量数据
   - 添加缓存过期机制 (`CACHE_MAX_AGE_DAYS`)
   - 添加缓存大小限制 (`CACHE_MAX_SIZE_MB`)
   - 自动清理过期/超量缓存

3. **对比语义约束**
   - 校验同数据集结果的 `true_value` 一致性（通过哈希比对）
   - 不一致时添加警告提示，避免"看起来能用但结论错误"

4. **数据库初始化修复**
   - 移除运行时自动建表逻辑，强制使用 Alembic 迁移
   - 修复 PostgreSQL 兼容性问题

5. **JWT 安全加固**
   - 生产环境强制要求设置 `JWT_SECRET_KEY` 环境变量
   - 开发环境使用随机密钥并显示警告

### 🟠 P1 级修复（重要改进）

1. **字段校验增强**
   - 更新接口添加枚举类型校验
   - 防止空字符串/非法值写入数据库

2. **文件与 DB 事务一致性**
   - 删除操作改为"先 commit 数据库，再删除文件"
   - 避免事务失败但文件已删除的问题

3. **NaN 处理策略统一**
   - 上传时：严格拒绝包含 NaN 的数据
   - 可视化时：过滤 NaN 并继续处理
   - 添加 `validate_numeric_data()` 统一处理函数

4. **线程池统一管理**
   - 创建共享的 `executor` 模块
   - 所有模块使用统一的线程池
   - 生命周期由 `lifespan` 统一管理

5. **枚举类型收敛**
   - 后端添加 `enums.py`，定义所有枚举类型
   - Schema 使用枚举类型进行校验

6. **移除 import 副作用**
   - 目录创建移至 `lifespan` 初始化
   - 避免干扰测试和迁移脚本

### 🟡 P2 级修复（优化）

1. **rawRequest 401 处理**
   - 下载请求也支持 Token 自动刷新

2. **TOKEN_KEY 统一定义**
   - 创建 `token.ts` 统一管理 Token 常量

3. **删除死代码**
   - 移除未使用的 `error.ts`

4. **文件路径安全验证**
   - 添加 `security.py` 模块
   - 下载接口验证文件路径在允许目录内

5. **datetime 兼容性**
   - 使用 `datetime.now(timezone.utc)` 替代已弃用的 `datetime.utcnow()`

6. **MAPE 数值稳定性**
   - 添加最小阈值避免除零
   - 限制最大值为 1000%

### 新增文件

```
backend/app/
├── schemas/
│   └── enums.py          # 枚举类型定义
├── services/
│   ├── executor.py       # 统一线程池管理
│   └── security.py       # 文件路径安全验证

frontend/src/api/
└── token.ts              # Token 常量和管理器
```

### 配置变更

新增环境变量：
- `ENABLE_DATA_ISOLATION`: 数据隔离模式开关
- `CACHE_MAX_AGE_DAYS`: 缓存最大保留天数
- `CACHE_MAX_SIZE_MB`: 缓存最大大小

---

十一、联系方式
如有问题，请联系项目负责人或在 Git 仓库提 Issue。

文档版本： v1.1
最后更新： 2026-01-08